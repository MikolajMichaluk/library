version: ~> 1.0

language: c

os:
  - linux

compiler:
  - clang
  - gcc

services:
  - docker

addons:
  apt:
    packages:
    - gfortran

# run on Ubuntu 16.04
dist: xenial

git:
  quiet: true

env:
  global:
    - PYPIUSER=libamtrack
    #  pypi secured password (PYPIPASS variable), you need to update it to your own if you want to use it
    - secure: "WLg9eOFwGwH2riVdcl2mdUjzBIx4NaamMmB6XNOtAl91cPK/LtchLaMVMjVlPKMchQ/cCVpVgjiqRgEUPLz40sfv+DqmcnZH7UXE4kpUuUtFECTpIqc69Ohzn82JdrKQIaH0FWPTjRvxZgV+b6KWo8TK71VFANPpQTuhfaRJ+laKj1S5ikwg4c1zj6kqYefGHhvdvs5LtBXEZ9UQg+dkuWK8mrnl/gpZUuR7P8o+wofv2X510kHrV8WkUDfk9JmfpRyTmpvJcawl5CpGeov7c6wz5+nKNg+Fki5qft2TEb6DsHCMOBI6UviMvROSPgNs/C4tI5zNtabs+61uwU2vHsEiOuHGbmMcfGaOyjumQPcyBz3bvQ+e7ZA1ZyYipw4ihU9M7sPZtmwSlxE2ECXXy/MjPyVharTiy3rGAYwT4rH+F8fubsYeYtFax4IUFQfq3DXS9YUCJ82bCRnDlzLZ5MLy/4WL+sL7nMLR9ApkN97MWkv+aqmYjvKG0N519HSVJwuptWkoCok8E7e3zi5nOiG5eJ/0f4TVlEyOPrxeCtWCOPATXb54vSz7GPvMgTx4CKFmNbe5sLhx1A8cuOikA1Keyii8VKda8LVr7gXDh8BvgcL/CIAF/pALf2cDL224Gy8Mlz32PqBJMSKuopeIRKnj2eN3GBL1t9GuiXb8oRg="

# Ubuntu 16.04 has pretty old (2.1) version of GSL
# libamtrack needs GSL version 2.5, hence we install it from deb packages of Ubuntu 18.04 repo
before_install:
  - python3 -V
  - mkdir m4
  - wget https://launchpad.net/ubuntu/+source/gsl/2.5+dfsg-5/+build/15307668/+files/libgslcblas0_2.5+dfsg-5_amd64.deb  # newest GSL (2.5) from Ubuntu 18.04 repo
  - wget https://launchpad.net/ubuntu/+source/gsl/2.5+dfsg-5/+build/15307668/+files/libgsl23_2.5+dfsg-5_amd64.deb
  - wget https://launchpad.net/ubuntu/+source/gsl/2.5+dfsg-5/+build/15307668/+files/libgsl-dev_2.5+dfsg-5_amd64.deb
  - wget https://launchpad.net/ubuntu/+source/gsl/2.5+dfsg-5/+build/15307668/+files/gsl-bin_2.5+dfsg-5_amd64.deb
  - sudo dpkg -i *.deb
  - gsl-config --version # print the currently installed version of GSL
  - autoreconf --force --install

install:
  - ./configure --prefix=$HOME/usr

# If before_install, install or before_script returns a non-zero exit code, the build is errored and stops immediately.
before_script:
  - make README
  - make -j2
  - make install

# If script returns a non-zero exit code, the build is failed, but continues to run before being marked as failed.
script:
  - $HOME/usr/bin/amtrack_test
  - $HOME/usr/bin/amtrack_demo
  - cd distributions/Python/pyamtrack && ./make_wheel_package.sh && ./test_wheel_package.sh
  - if [[ "$TRAVIS_TEST_RESULT" == "0" ]] && [[ $TRAVIS_TAG ]]; then $TRAVIS_BUILD_DIR/distributions/Python/pyamtrack/deploy_package.sh; fi

  # Trigger rebuild image in docker hub libamtrack/libamtrackforjs
  - if [[ "$TRAVIS_TEST_RESULT" == "0" ]] && [[ $TRAVIS_BRANCH == "master" ]]; then $TRAVIS_BUILD_DIR/distributions/JavaScript/trigger_docker_rebuild.sh; fi
